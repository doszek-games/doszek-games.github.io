# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

GameCache is a static website generator that creates a searchable board game collection viewer hosted on GitHub Pages. It fetches data from BoardGameGeek (BGG), creates a SQLite database, and deploys it as a release asset that the frontend consumes.

## Architecture

### Backend (Python scripts in `scripts/`)

**Main workflow orchestration:**
- `download_and_index.py` - Main entry point that orchestrates the entire data pipeline
- `setup_bgg_token.py` - Generates BGG API token using the shared GameCache BGG application
- `validate_setup.py` - Validates configuration and checks BGG username exists
- `enable_hourly_updates.py` - Configures GitHub Actions for automatic hourly updates

**Core package (`scripts/gamecache/`):**
- `config.py` - Parses `config.ini` and loads BGG token from environment or `.env` file
- `downloader.py` - Fetches collection, plays, and game data from BGG API using `bgg_client.py`
- `models.py` - `BoardGame` class that processes raw BGG data and calculates derived fields
- `sqlite_indexer.py` - Creates SQLite database with games table, extracts dominant colors from images
- `github_integration.py` - Handles OAuth device flow authentication and uploads database to GitHub releases
- `bgg_client.py` - Low-level BGG XML API client with optional SQLite caching
- `http_client.py` - HTTP request wrapper used by both BGG and GitHub clients

**Data flow:**
1. `download_and_index.py` reads `config.ini` (title, bgg_username, github_repo)
2. `Downloader` fetches collection, plays, and detailed game data from BGG
3. Raw game data â†’ `BoardGame` model (calculates player counts, playing time buckets, weight, etc.)
4. `SqliteIndexer` creates database, extracts dominant color from each game image
5. Database is gzipped to `gamecache.sqlite.gz`
6. `GitHubReleaseManager` uploads to GitHub release (tag: "database", asset: "gamecache.sqlite.gz")

**Authentication:**
- BGG token: Generated by `setup_bgg_token.py`, stored in `.env` as `GAMECACHE_BGG_TOKEN`
- GitHub token: OAuth device flow (stored in `~/.gamecache/token.json`) or `GAMECACHE_GITHUB_TOKEN` env var

### Frontend (Static HTML/JS)

- `index.html` - Single-page app using vanilla JavaScript
- `app-sqlite.js` - Loads `gamecache.sqlite.gz` from GitHub releases, performs client-side SQL queries
- Frontend uses sql.js (SQLite compiled to WebAssembly) to query the database locally

### CI/CD (`.github/workflows/index.yml`)

- Runs hourly via cron schedule (`0 * * * *`)
- Requires `GAMECACHE_GITHUB_TOKEN` and `GAMECACHE_BGG_TOKEN` repository secrets
- Runs `download_and_index.py --debug` to refresh the database

## Common Commands

### Initial Setup
```bash
# Install dependencies
pip install -r scripts/requirements.txt

# Edit config.ini with your BGG username and GitHub repo
vim config.ini

# Generate BGG token (reads username from config.ini)
python scripts/setup_bgg_token.py

# Validate configuration
python scripts/validate_setup.py
```

### Generate Database
```bash
# Full run (no caching, will take 5-15 minutes depending on collection size)
python scripts/download_and_index.py

# With BGG API caching (fast on subsequent runs)
python scripts/download_and_index.py --cache_bgg

# Skip GitHub upload (for testing)
python scripts/download_and_index.py --no_upload

# Debug mode (verbose logging)
python scripts/download_and_index.py --debug

# Custom config file
python scripts/download_and_index.py --config path/to/config.ini
```

### Enable Automatic Updates
```bash
# Configure hourly GitHub Actions workflow
python scripts/enable_hourly_updates.py
```

### Local Development
```bash
# Test website locally (serves on http://localhost:8000)
python -m http.server

# Check website functionality
python scripts/check_website.py
```

## Configuration

**config.ini format:**
```ini
title = "Your Collection Name"
bgg_username = YOUR_BGG_USERNAME
github_repo = USERNAME/REPO_NAME
```

**Environment variables:**
- `GAMECACHE_BGG_TOKEN` - BGG API token (generated by `setup_bgg_token.py`, stored in `.env`)
- `GAMECACHE_GITHUB_TOKEN` - GitHub token for CI/CD (set as repository secret)

## Key Implementation Details

### BoardGame Model Calculations
- **Player counts**: Combines official min/max, BGG suggested player counts, and expansion player counts
- **Playing time buckets**: Maps BGG's playing_time to categories (< 30min, 30min-1h, 1-2h, 2-3h, 3-4h, > 4h)
- **Weight**: Complexity rating from BGG (1-5 scale)
- **Rank**: BGG overall rank (null if "Not Ranked")

### Color Extraction
`sqlite_indexer.py` uses colorgram to extract dominant color from game images:
- Extracts up to 10 colors
- Selects first color with luma between 0.2-0.8 (not too dark/light)
- Falls back to white (255, 255, 255) if extraction fails
- Stored as RGB string: "255, 255, 255"

### GitHub Release Strategy
- Single release with tag "database"
- Asset name: "gamecache.sqlite.gz"
- Old asset is deleted before uploading new one
- Public download URL: `https://github.com/OWNER/REPO/releases/latest/download/gamecache.sqlite.gz`

### BGG API Token
Uses shared GameCache BGG application for automatic token generation:
- No manual BGG app registration required
- Token stored in `.env` file (git-ignored)
- Loaded from environment variable or `.env` file by `config.py`

## Python Version Compatibility

Project tested with Python 3.8-3.12. For Python 3.13+:
```bash
pip install pip-tools
pip-compile scripts/requirements.in -o scripts/requirements.txt
pip install -r scripts/requirements.txt
```

## Deployment

Website is hosted on GitHub Pages:
1. Enable GitHub Pages in repository settings (deploy from master branch)
2. Run `download_and_index.py` to generate and upload database
3. Visit `https://USERNAME.github.io/REPO_NAME`

For automatic updates, run `enable_hourly_updates.py` to configure GitHub Actions.
